---
import { z } from "zod";

import Layout from "@/layouts/Layout.astro";
import { RecipeService } from "@/lib/services/recipe.service";

import RecipeHeader from "@/components/recipe/RecipeHeader.astro";
import IngredientsSection from "@/components/recipe/IngredientsSection.astro";
import InstructionsSection from "@/components/recipe/InstructionsSection.astro";
import RecipeActions from "@/components/recipe/RecipeActions";
import RecipeStatusCard from "@/components/recipe/RecipeStatusCard.astro";

import type { RecipeIngredientJson, RecipeInstructionJson } from "@/types";

export const prerender = false;

const idSchema = z.string().uuid();
const rawId = Astro.params.id;
const isValidId = idSchema.safeParse(rawId).success;

if (!isValidId) {
  Astro.response.status = 404;
}

const recipeService = new RecipeService(Astro.locals.supabase);

let recipe: Awaited<ReturnType<RecipeService["getRecipeById"]>> = null;
if (isValidId) {
  try {
    recipe = await recipeService.getRecipeById(rawId ?? "");
    if (!recipe) {
      Astro.response.status = 404;
    }
  } catch (error) {
    const status =
      error && typeof error === "object" && "status" in error ? Number((error as { status?: number }).status) : null;
    if (status === 401 || status === 403) {
      Astro.response.status = 403;
    } else {
      Astro.response.status = 500;
    }
  }
}

const coerceJsonArray = <T,>(value: unknown): T[] => {
  if (Array.isArray(value)) return value as T[];
  if (typeof value === "string") {
    try {
      const parsed = JSON.parse(value);
      return Array.isArray(parsed) ? (parsed as T[]) : [];
    } catch {
      return [];
    }
  }
  return [];
};

const ingredients: RecipeIngredientJson[] = recipe ? coerceJsonArray<RecipeIngredientJson>(recipe.ingredients) : [];
const instructions: RecipeInstructionJson[] = recipe ? coerceJsonArray<RecipeInstructionJson>(recipe.instructions) : [];
const aiNotes = recipe && "ai_notes" in recipe ? ((recipe as { ai_notes?: string | null }).ai_notes ?? null) : null;

const isNotFound = Astro.response.status === 404;
const isForbidden = Astro.response.status === 403;
const isError = Astro.response.status === 500;
const recipeView = Astro.response.status === 200 && recipe ? recipe : null;
---

<Layout title={recipe ? recipe.title : "Recipe"}>
  <main class="min-h-screen">
    <div class="container mx-auto px-4 py-8 md:py-10 space-y-6">
      {
        isNotFound && (
          <RecipeStatusCard
            title="Recipe not found"
            description="Check the link or go back to the homepage."
            href="/"
            linkText="Go back"
          />
        )
      }

      {
        isError && (
          <RecipeStatusCard
            title="Something went wrong"
            description="We couldn’t load this recipe. Please try again in a moment."
            href="/"
            linkText="Go back"
          />
        )
      }

      {
        isForbidden && (
          <RecipeStatusCard
            title="Access denied"
            description="You don’t have permission to view this recipe."
            href="/"
            linkText="Go back"
          />
        )
      }

      {
        recipeView && (
          <>
            <RecipeHeader
              title={recipeView.title}
              prepTimeMinutes={recipeView.prep_time_minutes}
              dietLabel={recipeView.diet_label}
              calories={recipeView.calories}
              aiNotes={aiNotes}
            />

            <section class="grid gap-4 md:grid-cols-2">
              <IngredientsSection ingredients={ingredients} />
              <InstructionsSection instructions={instructions} />
            </section>
          </>
        )
      }
    </div>

    {
      recipeView && (
        <RecipeActions
          client:idle
          recipeId={recipeView.id}
          recipeTitle={recipeView.title}
          ingredients={ingredients}
          instructions={instructions}
        />
      )
    }
  </main>
</Layout>
